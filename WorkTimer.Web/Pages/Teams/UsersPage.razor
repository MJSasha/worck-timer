@using QuickActions.Common.Specifications
@using WorkTimer.Common.Interfaces
@using WorkTimer.Common.Models
@using WorkTimer.Web.Dialogs

@page "/users"

@attribute [Authorize]

<PageLayout PageTitle="Статистика">
    <Content>
        <div class="d-flex justify-content-center w-100 p-3">
            <MudTable Hover Striped Style="min-width: 60%" Items="@Users" OnRowClick="new EventCallback<TableRowClickEventArgs<User>>(this, RowClickEvent)" Filter="new Func<User,bool>(FilterUsers)">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Пользователи</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Имя</MudTh>
                    <MudTh>Почта</MudTh>
                    <MudTh>Роль</MudTh>
                    <MudTh>Оклад</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Имя">@context.Name</MudTd>
                    <MudTd DataLabel="Почта">@context.Email</MudTd>
                    <MudTd DataLabel="Роль">@context.Role</MudTd>
                    <MudTd DataLabel="Роль">@context.Salary</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </div>
    </Content>
</PageLayout>

    @code {

    [Inject]
    public IUsers UsersService { get; set; }

    [Inject]
    public DialogsService DialogsService { get; set; }

    private string searchString = "";
    private HashSet<User> selectedItems = new HashSet<User>();

    private List<User> Users = new List<User>();

    protected override async Task OnInitializedAsync()
    {
        Users = await UsersService.Read(new Specification<User>(), 0, int.MaxValue);
    }

    private bool FilterUsers(User element) => FilterUsers(element, searchString);

    private bool FilterUsers(User element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (element.Email.Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }

    private Task RowClickEvent(TableRowClickEventArgs<User> tableRowClickEventArgs)
    {
        return ShowUserInfo(tableRowClickEventArgs.Item);
    }

    private async Task ShowUserInfo(User user)
    {
        try
        {
            await DialogsService.Show<UsersDataDialog, User, object>(user);
        }
        catch (ObjectDisposedException) { /* ignore */ }
    }
}